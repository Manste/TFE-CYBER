rule "Check if unauthorized person performed crucial action"
when
    Item DetectedPerson changed or
    Item DetectedAction changed
then
    val unauthorizedPersons = newArrayList("Unknown", "Annalise Keating")
    val dangerousActions = newArrayList("open")

    val personListString = RecognizedPerson.state.toString
    val imagePathString = PersonImage.state.toString
    val action = DetectedAction.state.toString

    // Convert JSON lists to OpenHAB lists
    val personList = transform("JSONPATH", "$", personListString).split(",")
    val imagePaths = transform("JSONPATH", "$", imagePathString).split(",")

    for (index : (0..personList.size - 1)) {
        val person = personList.get(index).trim()
        val imagePath = imagePaths.get(index).trim()

        if (unauthorizedPersons.contains(person) && dangerousActions.contains(action)) {
            logWarn("Security", "ALERT! Unauthorized person " + person + " is doing " + action)
            AlertTriggered.sendCommand(ON)

            // Trigger alarm module with person name & image path
            executeCommandLine("python3 /etc/openhab/scripts/alarm.py " + person + " " + imagePath)
        }
    }
end
